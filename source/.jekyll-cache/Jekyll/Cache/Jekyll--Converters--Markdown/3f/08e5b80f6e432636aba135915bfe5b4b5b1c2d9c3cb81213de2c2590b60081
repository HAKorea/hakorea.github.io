I"Z=<p>The <code>recorder</code> integration is responsible for storing details in a database, which then are handled by the <a href="/integrations/history/"><code>history</code> integration</a>.</p>
<p>Home Assistant uses <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>, which is an Object Relational Mapper (ORM). This means that you can use <strong>any</strong> SQL backend for the recorder that is supported by SQLAlchemy, like <a href="https://www.mysql.com/">MySQL</a>, <a href="https://mariadb.org/">MariaDB</a>, <a href="https://www.postgresql.org/">PostgreSQL</a>, or <a href="https://www.microsoft.com/en-us/sql-server/">MS SQL Server</a>.</p>
<p>The default database engine is <a href="https://www.sqlite.org/">SQLite</a> which doesn’t require any configuration. The database is stored in your Home Assistant configuration directory (<code>.homeassistant</code> or ‘/config/’ in Hass.io) and called <code>home-assistant_v2.db</code>.</p>
<p>To change the defaults for the <code>recorder</code> integration in your installation, add the following to your <code>configuration.yaml</code> file:</p>
<pre><code class="language-yaml"># Example configuration.yaml entry
recorder:
</code></pre>
<div class="config-vars">
  <h3><a class="title-link" name="configuration-variables" href="#configuration-variables"></a> Configuration Variables</h3>
  <dl class=''><dt><a class='title-link' name='recorder' href='#recorder'></a> recorder</dt><dd><p class='desc'><span class='type'>(<span class='map'>map</span>)</span><span class='required'>(Required)</span><span class='description'><p>Enables the recorder integration. Only allowed once.</p>
</span></p></dd><dd><dl class='nested'><dt><a class='title-link' name='db_url' href='#db_url'></a> db_url</dt><dd><p class='desc'><span class='type'>(<span class='string'>string</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The URL that points to your database.</p>
</span></p></dd><dt><a class='title-link' name='purge_keep_days' href='#purge_keep_days'></a> purge_keep_days</dt><dd><p class='desc'><span class='type'>(<span class='integer'>integer</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Specify the number of history days to keep in recorder database after a purge.</p>
</span></p><p class='default'>
Default value: <p>10</p>
</p></dd><dt><a class='title-link' name='purge_interval' href='#purge_interval'></a> purge_interval</dt><dd><p class='desc'><span class='type'>(<span class='integer'>integer</span>)</span><span class='required'>(Optional)</span><span class='description'><p>How often (in days) the purge task runs. If a scheduled purge is missed (e.g., if Home Assistant was not running), the schedule will resume soon after Home Assistant restarts. You can use the <a href="#service-purge">service</a> call <code>purge</code> when required without impacting the purge schedule. If this is set to <code>0</code> (zero), automatic purging is disabled.</p>
</span></p><p class='default'>
Default value: <p>1</p>
</p></dd><dt><a class='title-link' name='exclude' href='#exclude'></a> exclude</dt><dd><p class='desc'><span class='type'>(<span class='map'>map</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Configure which integrations should be excluded from recordings.</p>
</span></p></dd><dd><dl class='nested'><dt><a class='title-link' name='domains' href='#domains'></a> domains</dt><dd><p class='desc'><span class='type'>(<span class='list'>list</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The list of domains to be excluded from recordings.</p>
</span></p></dd><dt><a class='title-link' name='entities' href='#entities'></a> entities</dt><dd><p class='desc'><span class='type'>(<span class='list'>list</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The list of entity ids to be excluded from recordings.</p>
</span></p></dd></dl></dd><dt><a class='title-link' name='include' href='#include'></a> include</dt><dd><p class='desc'><span class='type'>(<span class='map'>map</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Configure which integrations should be included in recordings. If set, all other entities will not be recorded.</p>
</span></p></dd><dd><dl class='nested'><dt><a class='title-link' name='domains' href='#domains'></a> domains</dt><dd><p class='desc'><span class='type'>(<span class='list'>list</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The list of domains to be included in the recordings.</p>
</span></p></dd><dt><a class='title-link' name='entities' href='#entities'></a> entities</dt><dd><p class='desc'><span class='type'>(<span class='list'>list</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The list of entity ids to be included in the recordings.</p>
</span></p></dd></dl></dd></dl></dd></dl>
</div>
<p>Defining domains and entities to <code>exclude</code> (aka. blacklist) is convenient when you are basically happy with the information recorded, but just want to remove some entities or domains. Usually, these are entities/domains that do not change (like <code>weblink</code>) or rarely change (like <code>updater</code> or <code>automation</code>).</p>
<pre><code class="language-yaml"># Example configuration.yaml entry with exclude
recorder:
  purge_keep_days: 5
  db_url: sqlite:////home/user/.homeassistant/test
  exclude:
    domains:
      - automation
      - weblink
      - updater
    entities:
      - sun.sun # Don't record sun data
      - sensor.last_boot # Comes from 'systemmonitor' sensor platform
      - sensor.date
</code></pre>
<p>define domains and entities to record by using the <code>include</code> configuration (aka. whitelist) is convenient if you have a lot of entities in your system and your <code>exclude</code> lists possibly get very large, so it might be better just to define the entities or domains to record.</p>
<pre><code class="language-yaml"># Example configuration.yaml entry with include
recorder:
  include:
    domains:
      - sensor
      - switch
      - media_player
</code></pre>
<p>You can also use the <code>include</code> list to define the domains/entities to record, and exclude some of those within the <code>exclude</code> list. This makes sense if you, for instance, include the <code>sensor</code> domain, but want to exclude some specific sensors. Instead of adding every sensor entity to the <code>include</code> <code>entities</code> list just include the <code>sensor</code> domain and exclude the sensor entities you are not interested in.</p>
<pre><code class="language-yaml"># Example configuration.yaml entry with include and exclude
recorder:
  include:
    domains:
      - sensor
      - switch
      - media_player
  exclude:
    entities:
     - sensor.last_boot
     - sensor.date
</code></pre>
<p>If you only want to hide events from your history, take a look at the <a href="/integrations/history/"><code>history</code> integration</a>. The same goes for the <a href="/integrations/logbook/">logbook</a>. But if you have privacy concerns about certain events or want them in neither the history or logbook, you should use the <code>exclude</code>/<code>include</code> options of the <code>recorder</code> integration. That way they aren’t even in your database, you can reduce storage and keep the database small by excluding certain often-logged events (like <code>sensor.last_boot</code>).</p>
<h3>Service <code>purge</code></h3>
<p>Call the service <code>recorder.purge</code> to start a purge task which deletes events and states older than x days, according to <code>keep_days</code> service data.</p>
<table>
<thead>
<tr>
<th>Service data attribute</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>keep_days</code></td>
<td>yes</td>
<td>The number of history days to keep in recorder database (defaults to the integration <code>purge_keep_days</code> configuration)</td>
</tr>
<tr>
<td><code>repack</code></td>
<td>yes</td>
<td>Rewrite the entire database, possibly saving some disk space. Only supported for SQLite and requires at least as much disk space free as the database currently uses.</td>
</tr>
</tbody>
</table>
<h2>Custom database engines</h2>
<table>
<thead>
<tr>
<th align="left">Database engine</th>
<th align="left"><code>db_url</code></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">SQLite</td>
<td align="left"><code>sqlite:////PATH/TO/DB_NAME</code></td>
</tr>
<tr>
<td align="left">MariaDB</td>
<td align="left"><code>mysql+pymysql://SERVER_IP/DB_NAME?charset=utf8</code></td>
</tr>
<tr>
<td align="left">MariaDB</td>
<td align="left"><code>mysql+pymysql://user:password@SERVER_IP/DB_NAME?charset=utf8</code></td>
</tr>
<tr>
<td align="left">MariaDB (omit pymysql)</td>
<td align="left"><code>mysql://user:password@SERVER_IP/DB_NAME?charset=utf8</code></td>
</tr>
<tr>
<td align="left">MySQL</td>
<td align="left"><code>mysql://SERVER_IP/DB_NAME?charset=utf8</code></td>
</tr>
<tr>
<td align="left">MySQL</td>
<td align="left"><code>mysql://user:password@SERVER_IP/DB_NAME?charset=utf8</code></td>
</tr>
<tr>
<td align="left">PostgreSQL</td>
<td align="left"><code>postgresql://SERVER_IP/DB_NAME</code></td>
</tr>
<tr>
<td align="left">PostgreSQL</td>
<td align="left"><code>postgresql://user:password@SERVER_IP/DB_NAME</code></td>
</tr>
<tr>
<td align="left">PostgreSQL (Socket)</td>
<td align="left"><code>postgresql://@/DB_NAME</code></td>
</tr>
<tr>
<td align="left">MS SQL Server</td>
<td align="left"><code>mssql+pyodbc://username:password@SERVER_IP/DB_NAME?charset=utf8;DRIVER={DRIVER};Port=1433;</code></td>
</tr>
</tbody>
</table>
<div class='note'>
<p>Some installations of MariaDB/MySQL may require an ALTERNATE_PORT (3rd-party hosting providers or parallel installations) to be added to the SERVER_IP, e.g., <code>mysql://user:password@SERVER_IP:ALTERNATE_PORT/DB_NAME?charset=utf8</code>.</p>
</div>
<div class='note'>
<p>If using an external MariaDB backend (e.g., running on a separate NAS) with Home Assistant, you should omit <code>pymysql</code> from the URL. <code>pymysql</code> is not included in the base docker image, and is not necessary for this to work.</p>
</div>
<div class='note'>
<p>Unix Socket connections always bring performance advantages over TCP, if the database is on the same host as the <code>recorder</code> instance (i.e. <code>localhost</code>).</p>
</div>
<div class='note warning'>
<p>If you want to use Unix Sockets for PostgreSQL you need to modify the <code>pg_hba.conf</code>. See <a href="#postgresql">PostgreSQL</a></p>
</div>
<div class='note warning'>
<p>If you are using the default <code>FULL</code> recovery model for MS SQL Server you will need to manually backup your log file to prevent your transaction log from growing too large. It is recommended you change the recovery model to <code>SIMPLE</code> unless you are worried about data loss between backups.</p>
</div>
<h3>Database startup</h3>
<p>If you are running a database server instance on the same server as Home Assistant then you must ensure that this service starts before Home Assistant. For a Linux instance running Systemd (Raspberry Pi, Debian, Ubuntu and others) then you should edit the service file.</p>
<pre><code class="language-bash">sudo nano /etc/systemd/system/home-assistant@homeassistant.service
</code></pre>
<p>and add the service for the database, for example, PostgreSQL:</p>
<pre><code class="language-txt">[Unit]
Description=Home Assistant
After=network.target postgresql.service
</code></pre>
<p>Save the file then reload <code>systemctl</code>:</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
</code></pre>
<h2>Installation notes</h2>
<p>Not all Python bindings for the chosen database engine can be installed directly. This section contains additional details that should help you to get it working.</p>
<h3>MariaDB and MySQL</h3>
<p>If you are in a virtual environment, don’t forget to activate it before installing the <code>mysqlclient</code> Python package described below.</p>
<pre><code class="language-bash">pi@homeassistant:~ $ sudo -u homeassistant -H -s
homeassistant@homeassistant:~$ source /srv/homeassistant/bin/activate
(homeassistant) homeassistant@homeassistant:~$ pip3 install mysqlclient
</code></pre>
<p>For MariaDB you may have to install a few dependencies. If you’re using MariaDB version 10.2, <code>libmariadbclient-dev</code> was renamed to <code>libmariadb-dev</code>. If you’re using MariaDB 10.3, the package <code>libmariadb-dev-compat</code> must also be installed. For MariaDB v10.0.34 only <code>libmariadb-dev-compat</code> is needed. Please install the correct packages based on your MariaDB version.</p>
<p>On the Python side we use the <code>mysqlclient</code>:</p>
<pre><code class="language-bash">sudo apt-get install libmariadbclient-dev libssl-dev
pip3 install mysqlclient
</code></pre>
<p>For MySQL you may have to install a few dependencies. You can choose between <code>pymysql</code> and <code>mysqlclient</code>:</p>
<pre><code class="language-bash">sudo apt-get install default-libmysqlclient-dev libssl-dev
pip3 install mysqlclient
</code></pre>
<p>After installing the dependencies, it is required to create the database manually. During the startup, Home Assistant will look for the database specified in the <code>db_url</code>. If the database doesn’t exist, it will not automatically create it for you.</p>
<p>Once Home Assistant finds the database, with the right level of permissions, all the required tables will then be automatically created and the data will be populated accordingly.</p>
<h3>PostgreSQL</h3>
<p>For PostgreSQL you may have to install a few dependencies:</p>
<pre><code class="language-bash">sudo apt-get install postgresql-server-dev-X.Y
pip3 install psycopg2
</code></pre>
<p>For using Unix Sockets, add the following line to your <a href="https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html"><code>pg_hba.conf</code></a>:</p>
<p><code>local  DB_NAME USER_NAME peer</code></p>
<p>Where <code>DB_NAME</code> is the name of your database and <code>USER_NAME</code> is the name of the user running the Home Assistant instance (see <a href="/docs/configuration/securing/">securing your installation</a>).</p>
<p>Reload the PostgreSQL configuration after that:</p>
<pre><code class="language-bash">$ sudo -i -u postgres psql -c &quot;SELECT pg_reload_conf();&quot;
 pg_reload_conf
----------------
 t
(1 row)
</code></pre>
<p>A service restart will work as well.</p>
<h3>MS SQL Server</h3>
<p>For MS SQL Server you will have to install a few dependencies:</p>
<pre><code class="language-bash">sudo apt-get install unixodbc-dev
pip3 install pyodbc
</code></pre>
<p>If you are in a virtual environment, don’t forget to activate it before installing the pyodbc package.</p>
<pre><code class="language-bash">sudo -u homeassistant -H -s
source /srv/homeassistant/bin/activate
pip3 install pyodbc
</code></pre>
<p>You will also need to install an ODBC Driver. Microsoft ODBC drivers are recommended, however FreeTDS is available for systems that are not supported by Microsoft. Instrucitons for installing the Microsoft ODBC drivers can be found <a href="https://docs.microsoft.com/en-us/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server">here</a>.</p>
<div class='note'>
<p>If you are using Hass.io, FreeTDS is already installed for you. The db_url you need to use is <code>mssql+pyodbc://username:password@SERVER_IP/DB_NAME?charset=utf8;DRIVER={FreeTDS};Port=1433;</code>.</p>
</div>
:ET