I"R6<p>The <code>xiaomi_aqara</code> integration allows you to integrate <a href="https://www.mi.com/en/">Xiaomi</a> Aqara-compatible devices into Home Assistant.</p>
<p>Please note, there are two versions of the hub: v1 and v2. v1 can be used with Home Assistant without any problems, however, v2 might be less straight forward when it comes to enabling the local API, and might even require you to open up your device in order to do so. Xiaomi has suggested this is in the pipeline.</p>
<h2>Supported Devices</h2>
<ul>
<li>Aqara Air Conditioning Companion (lumi.acpartner.v3)</li>
<li>Aqara Intelligent Door Lock (lock.aq1)</li>
<li>Aqara Wall Switch (Double)</li>
<li>Aqara Wall Switch (Single)</li>
<li>Aqara Wall Switch LN (Double)</li>
<li>Aqara Wall Switch LN (Single)</li>
<li>Aqara Wireless Switch (Double)</li>
<li>Aqara Wireless Switch (Single)</li>
<li>Battery</li>
<li>Button 1st generation (Single, Double, Long Click)</li>
<li>Button 2nd generation (Single, Double)</li>
<li>Cube</li>
<li>Door and Window Sensor (1st and 2nd generation)</li>
<li>Gas Leak Detector (reports alarm and density)</li>
<li>Gateway (Light, Illumination Sensor, Ringtone play)</li>
<li>Intelligent Curtain</li>
<li>Motion Sensor (1st and 2nd generation)</li>
<li>Plug aka Socket (Zigbee version, reports power consumed, power load, state and if the device is in use)</li>
<li>Smoke Detector (reports alarm and density)</li>
<li>Temperature and Humidity Sensor (1st and 2nd generation)</li>
<li>Vibration Sensor</li>
<li>Wall Plug (reports power consumed, power load, and state)</li>
<li>Water Leak Sensor</li>
<li>Xiaomi Mijia Gateway (lumi.gateway.v2, lumi.gateway.v3)</li>
</ul>
<h2>Unsupported Devices</h2>
<ul>
<li>Xiaomi Aqara Gateway (lumi.gateway.aqhm01), as it is not possible to activate dev mode in the Mi Home App.</li>
<li>Gateway Radio</li>
<li>Gateway Button</li>
<li>Xiaomi Mi Air Conditioning Companion (lumi.acpartner.v2)</li>
<li>Aqara Intelligent Air Conditioner Controller Hub (lumi.acpartner.v1)</li>
<li>Decoupled mode of the Aqara Wall Switches (Single &amp; Double)</li>
<li>Additional alarm events of the Gas and Smoke Detector: Analog alarm, battery fault alarm (smoke detector only), sensitivity fault alarm, I2C communication failure</li>
</ul>
<h2>Setup</h2>
<p>Follow the setup process using your phone and Mi-Home app. From here you will be able to retrieve the key (password) from within the app following <a href="https://www.domoticz.com/wiki/Xiaomi_Gateway_(Aqara)#Adding_the_Xiaomi_Gateway_to_Domoticz">this tutorial</a>.</p>
<p>To enable Xiaomi Gateway (Aqara) in your installation, add the following to your <code>configuration.yaml</code> file:</p>
<h3>One Gateway</h3>
<pre><code class="language-yaml"># You can leave MAC empty if you only have one gateway.
xiaomi_aqara:
  discovery_retry: 5
  gateways:
    - key: xxxxxxxxxxxxxxxx
</code></pre>
<h3>Multiple Gateways</h3>
<pre><code class="language-yaml"># 12 characters MAC can be obtained from the gateway.
xiaomi_aqara:
  gateways:
    - mac: xxxxxxxxxxxx
      key: xxxxxxxxxxxxxxxx
    - mac: xxxxxxxxxxxx
      key: xxxxxxxxxxxxxxxx
</code></pre>
<h3>Search for gateways on specific interface</h3>
<pre><code class="language-yaml"># 12 characters MAC can be obtained from the gateway.
xiaomi_aqara:
  interface: '192.168.0.1'
  gateways:
    - mac: xxxxxxxxxxxx
      key: xxxxxxxxxxxxxxxx
</code></pre>
<div class="config-vars">
  <h3><a class="title-link" name="configuration-variables" href="#configuration-variables"></a> Configuration Variables</h3>
  <dl class=''><dt><a class='title-link' name='gateways' href='#gateways'></a> gateways</dt><dd><p class='desc'><span class='type'>(<span class='map'>map</span>)</span><span class='required'>(Required)</span><span class='description'><p>A list of gateways to set up.</p>
</span></p></dd><dd><dl class='nested'><dt><a class='title-link' name='mac' href='#mac'></a> mac</dt><dd><p class='desc'><span class='type'>(<span class='string'>string</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The MAC address of your gateway. Needs to be formatted without “:”. <em>Optional if only using one gateway.</em></p>
</span></p></dd><dt><a class='title-link' name='key' href='#key'></a> key</dt><dd><p class='desc'><span class='type'>(<span class='string'>string</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The key of your gateway. <em>Optional if only using sensors and/or binary sensors.</em></p>
</span></p></dd><dt><a class='title-link' name='host' href='#host'></a> host</dt><dd><p class='desc'><span class='type'>(<span class='string'>string</span>)</span><span class='required'>(Optional)</span><span class='description'><p>The host/IP address of the gateway. If this parameter is used the multicast discovery of the gateway is skipped.</p>
</span></p></dd><dt><a class='title-link' name='disable' href='#disable'></a> disable</dt><dd><p class='desc'><span class='type'>(<span class='boolean'>boolean</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Disable the gateway. This is only useful if you don’t want to integrate a specific gateway.</p>
</span></p><p class='default'>
Default value: <p>false</p>
</p></dd></dl></dd><dt><a class='title-link' name='discovery_retry' href='#discovery_retry'></a> discovery_retry</dt><dd><p class='desc'><span class='type'>(<span class='integer'>integer</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Number of times that Home Assistant should try to reconnect to the gateway.</p>
</span></p><p class='default'>
Default value: <p>3</p>
</p></dd><dt><a class='title-link' name='interface' href='#interface'></a> interface</dt><dd><p class='desc'><span class='type'>(<span class='string'>string</span>)</span><span class='required'>(Optional)</span><span class='description'><p>Which network interface to use.</p>
</span></p><p class='default'>
Default value: <p>any</p>
</p></dd></dl>
</div>
<h3>Services</h3>
<p>The gateway provides the following services:</p>
<h4>Service <code>xiaomi_aqara.play_ringtone</code></h4>
<p>Play a specific ringtone. The version of the gateway firmware must be <code>1.4.1_145</code> at least. Take a look at the examples below.</p>
<table>
<thead>
<tr>
<th>Service data attribute</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gw_mac</code></td>
<td>no</td>
<td>MAC address of the Xiaomi Aqara Gateway</td>
</tr>
<tr>
<td><code>ringtone_id</code></td>
<td>no</td>
<td>One of the allowed ringtone ids</td>
</tr>
<tr>
<td><code>ringtone_vol</code></td>
<td>yes</td>
<td>The volume in percent</td>
</tr>
</tbody>
</table>
<p>Allowed values of the <code>ringtone_id</code> are:</p>
<ul>
<li>Alarms
<ul>
<li>0 - Police car 1</li>
<li>1 - Police car 2</li>
<li>2 - Accident</li>
<li>3 - Countdown</li>
<li>4 - Ghost</li>
<li>5 - Sniper rifle</li>
<li>6 - Battle</li>
<li>7 - Air raid</li>
<li>8 - Bark</li>
</ul>
</li>
<li>Doorbells
<ul>
<li>10 - Doorbell</li>
<li>11 - Knock at a door</li>
<li>12 - Amuse</li>
<li>13 - Alarm clock</li>
</ul>
</li>
<li>Alarm clock
<ul>
<li>20 - MiMix</li>
<li>21 - Enthusiastic</li>
<li>22 - GuitarClassic</li>
<li>23 - IceWorldPiano</li>
<li>24 - LeisureTime</li>
<li>25 - ChildHood</li>
<li>26 - MorningStreamLiet</li>
<li>27 - MusicBox</li>
<li>28 - Orange</li>
<li>29 - Thinker</li>
</ul>
</li>
<li>Custom ringtones (uploaded by the Mi Home app) starting from 10001</li>
</ul>
<h4>Service <code>xiaomi_aqara.stop_ringtone</code></h4>
<p>Stops a playing ringtone immediately.</p>
<table>
<thead>
<tr>
<th>Service data attribute</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gw_mac</code></td>
<td>no</td>
<td>MAC address of the Xiaomi Aqara Gateway</td>
</tr>
</tbody>
</table>
<h4>Service <code>xiaomi_aqara.add_device</code></h4>
<p>Enables the join permission of the Xiaomi Aqara Gateway for 30 seconds. A new device can be added afterwards by pressing the pairing button once.</p>
<table>
<thead>
<tr>
<th>Service data attribute</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gw_mac</code></td>
<td>no</td>
<td>MAC address of the Xiaomi Aqara Gateway</td>
</tr>
</tbody>
</table>
<h4>Service <code>xiaomi_aqara.remove_device</code></h4>
<p>Removes a specific device. The removal is required if a device shall be paired with another gateway.</p>
<table>
<thead>
<tr>
<th>Service data attribute</th>
<th>Optional</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gw_mac</code></td>
<td>no</td>
<td>MAC address of the Xiaomi Aqara Gateway</td>
</tr>
<tr>
<td><code>device_id</code></td>
<td>no</td>
<td>Hardware address of the device to remove</td>
</tr>
</tbody>
</table>
<h2>Examples</h2>
<h3>Long Press on Smart Button 1st Generation</h3>
<p>This example plays the sound of a dog barking when the button is held down and stops the sound when the button is pressed once. Only works for the round button of the 1st generation.</p>
<p><em>Note: The sound will stop playing automatically when it has ended.</em></p>
<pre><code class="language-yaml">- alias: Let a dog bark on long press
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000xxxxxc2
      click_type: long_click_press
  action:
    service: xiaomi_aqara.play_ringtone
    data:
      gw_mac: xxxxxxxxxxxx
      ringtone_id: 8
      ringtone_vol: 8

- alias: Stop barking immediately on single click
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000xxxxxc2
      click_type: single
  action:
    service: xiaomi_aqara.stop_ringtone
    data:
      gw_mac: xxxxxxxxxxxx
</code></pre>
<h3>Double Click on Smart Button</h3>
<p>This example toggles the living room lamp on a double click of the button.</p>
<pre><code class="language-yaml">- alias: Double Click to toggle living room lamp
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000xxxxxc2
      click_type: double
  action:
    service: light.toggle
    data:
      entity_id: light.living_room_lamp
</code></pre>
<h2>Troubleshooting</h2>
<h3>Initial setup problem</h3>
<p>If you run into trouble initializing the gateway with your app, try another smartphone. E.g., it didn’t work on an OnePlus 3, but it worked with a Nexus 5.</p>
<h3>Connection problem</h3>
<pre><code class="language-bash">2017-08-20 16:51:19 ERROR (SyncWorker_0) [homeassistant.components.xiaomi] No gateway discovered
2017-08-20 16:51:20 ERROR (MainThread) [homeassistant.setup] Setup failed for xiaomi: Component failed to initialize.
</code></pre>
<p>That means that Home Assistant is not getting any response from your Xiaomi gateway. Might be a local network problem or your firewall.</p>
<ul>
<li>Make sure you have <a href="https://www.domoticz.com/wiki/Xiaomi_Gateway_(Aqara)#Adding_the_Xiaomi_Gateway_to_Domoticz">enabled LAN access</a>.</li>
<li>Turn off the firewall on the system where Home Assistant is running.</li>
<li>Ensure your router supports multicast as this is a requirement of the Xiaomi Gateway.</li>
<li>Try to leave the MAC address <code>mac:</code> blank.</li>
<li>Try to set <code>discovery_retry: 10</code>.</li>
<li>Try to disable and then enable LAN access.</li>
<li>Hard reset the gateway: Press the button of the gateway 30 seconds and start again from scratch.</li>
<li>If you are using Home Assistant in <a href="/docs/installation/docker/">Docker</a>, make sure to use <code>--net=host</code>.</li>
<li>If you receive an <code>{&quot;error&quot;:&quot;Invalid key&quot;}</code> in your log while trying to control the gateway light
<ul>
<li>You should generate the key again using an Android Phone or alternatively an emulator such as <a href="https://www.bluestacks.com">bluestacks</a>. In some instances, there is an issue with keys being generated using the iOS application.</li>
<li>You need to make sure to have multicast support on your network. If you are running Home Assistant in a virtual machine (like Proxmox), try <code>echo 0 &gt;/sys/class/net/vmbr0/bridge/multicast_snooping</code> on the host and restart the service or reboot the host.</li>
</ul>
</li>
<li>If the required library “PyXiaomiGateway” cannot be installed you will need to install some missing system dependencies <code>python3-dev</code>, <code>libssl-dev</code>, <code>libffi-dev</code> manually (e.g., <code>$ sudo apt-get install python3-dev libssl-dev libffi-dev</code>).</li>
<li>If your gateway’s MAC address starts with <code>04:CF:8C</code> or <code>7C:49:EB</code>, there is a good chance that the required port <code>9898</code> is closed on your gateway (you can check it with the Nmap utility, using the command <code>sudo nmap -sU {gateway_ip} -p 9898</code>). To fix that issue, you need to do these steps:
<ul>
<li>Find a specific screw bit (like a fork) to open the gateway case.</li>
<li>Find a USB-UART cable/module and connect it to your computer.</li>
<li>Solder 3 wires - RX, TX and GND like <a href="https://cs5-3.4pda.to/14176168/IMG_20181020_201150.jpg">here</a>.</li>
<li>Turn on the gateway (220V).</li>
<li>Open a serial terminal application (e.g. PuTTY) and connect to the serial port assigned to the USB-UART module (baudrate: 115200).</li>
<li>Wait until the gateway is booted up, connect the RX, TX and GND wires to the UART module (don’t connect the Vcc (power) wire!).</li>
<li>You will see all the messages from the gateway.</li>
<li>Send the command <code>psm-set network open_pf 3</code> (the command has to end with a <code>CR</code> newline character).</li>
<li>Check your settings executing the command <code>psm-get network open_pf</code> to be sure it’s OK.</li>
<li>Restart the gateway.</li>
</ul>
</li>
</ul>
:ET