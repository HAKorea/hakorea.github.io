<!doctype html>
  <!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>로그인감시(Fail2Ban) - 홈어시스턴트</title>
    <meta name="author" content="Home Assistant">
    <meta name="description" content="Instructions on how to integrate a fail2ban sensor into Home Assistant.">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="https://hakorea.github.io/integrations/fail2ban/">

    <meta property="fb:app_id" content="">
    <meta property="og:title" content="로그인감시(Fail2Ban)">
    <meta property="og:site_name" content="홈어시스턴트">
    <meta property="og:url" content="https://hakorea.github.io/integrations/fail2ban/">
    <meta property="og:type" content="article">
    <meta property="og:description" content="Instructions on how to integrate a fail2ban sensor into Home Assistant.">
    <meta property="og:image" content="https://hakorea.github.io/images/default-social.png">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@">
    
    <meta name="twitter:title" content="로그인감시(Fail2Ban)">
    <meta name="twitter:description" content="Instructions on how to integrate a fail2ban sensor into Home Assistant.">
    <meta name="twitter:image" content="https://hakorea.github.io/images/default-social.png">

    <link href="/stylesheets/prism.css?8acb84bc0387c9548a63998fcfea0139" rel="stylesheet">
    <link href="/stylesheets/screen.css?0a23d70030bf362ca935e76ccc50922c" media="screen, projection, print" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="홈어시스턴트" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />
  </head>

  <body >

    <header class='site-header'>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
      <a href="/" class="site-title">
        <img src="/images/home-assistant-logo.png" width="36" height="36" alt="Home Assistant">
        <span>홈어시스턴트</span>
      </a>
    </div>

    <div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
      <nav>
        <input type="checkbox" id="toggle">
        <label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
        <ul class="menu pull-right">
            
            <li><a href="/getting-started/">시작하기</a></li>
            <li><a href="/integrations/">통합구성요소</a></li>
            <li><a href="/docs/">문서</a></li>
            <li><a href="/cookbook/">예제</a></li>
            <li><a href='#' class='show-search'><i class="icon-search"></i></a></li>
            <li>KOREAN(not official)</li>
        </ul>
      </nav>

      <div class='search-container' style='display: none'>
        <div class='search'>
          <i class="icon-search"></i>
          <input id='search' placeholder='Search the docs…'>
          <a href='#' class='close'><i class="icon-remove-sign"></i></a>
        </div>
      </div>
    </div>
  </div>
</div>

    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          
            <article class="page">
  
  
    

<div class="edit-github"><a href="https://github.com/hakorea/gitpages_source/blob/master/source/_integrations/fail2ban.markdown" rel="external nofollow">깃허브 편집</a></div>


  

  
  <header>
    <h1 class="title indent">
      로그인감시(Fail2Ban)
    </h1>
  </header>
  <hr class="divider">
  

  <p><code>fail2ban</code> 센서는 <a href="https://www.fail2ban.org/wiki/index.php/Main_Page" rel="external nofollow">fail2ban</a>에 의해 금지된 IP가 홈 어시스턴트 프론트 엔드에 표시되도록합니다.</p>
<div class="note">
<p>이 센서가 작동하려면 시스템에 <code>fail2ban</code>이 설치되어 있고 올바르게 설정되어 있어야합니다. 또한 홈어시스턴트는 <code>fail2ban</code> 로그 파일을 읽을 수 있어야합니다.</p>
</div>
<h2>
<a class="title-link" name="" href="#"></a> 설정</h2>
<p>이 센서를 활성화하려면 <code>configuration.yaml</code>에 다음 줄을 추가하십시오</p>
<pre><code class="language-yaml"># Example configuration.yaml entry
sensor:
  - platform: fail2ban
    jails:
      - ssh
      - hass-iptables
</code></pre>
<div class="config-vars">
  <h3>
<a class="title-link" name="configuration-variables" href="#configuration-variables"></a> Configuration Variables</h3>
  <dl class="">
<dt>
<a class="title-link" name="jails" href="#jails"></a> jails</dt>
<dd><p class="desc"><span class="type">(<span class="list">list</span>)</span><span class="required">(Required)</span><span class="description"><p>표시하려는 설정된 감옥(jail) 목록.</p>
</span></p></dd>
<dt>
<a class="title-link" name="name" href="#name"></a> name</dt>
<dd>
<p class="desc"><span class="type">(<span class="string">string</span>)</span><span class="required">(Optional)</span><span class="description"><p>센서 이름.</p>
</span></p>
<p class="default">
Default value: </p>
<p>fail2ban</p>
</dd>
<dt>
<a class="title-link" name="file_path" href="#file_path"></a> file_path</dt>
<dd>
<p class="desc"><span class="type">(<span class="string">string</span>)</span><span class="required">(Optional)</span><span class="description"><p>fail2ban 로그의 경로</p>
</span></p>
<p class="default">
Default value: </p>
<p>/var/log/fail2ban.log</p>
</dd>
</dl>
</div>
<h3>
<a class="title-link" name="fail2ban-" href="#fail2ban-"></a> Fail2Ban 셋업</h3>
<p>대부분의 설정에서 <a href="/cookbook/fail2ban/">this tutorial</a>에 따라 시스템에서 <code>fail2ban</code>을 설정할 수 있습니다. 너무 많은 SSH 로그인 시도와 금지된 홈어시스턴트 로그인 시도에 대해 금지된 IP 주소를 모니터 할 수 있도록 감옥(jail)과 필터를 작성하는 과정을 안내합니다.</p>
<h3>
<a class="title-link" name="docker-fail2ban" href="#docker-fail2ban"></a> Docker에서의 Fail2Ban</h3>
<div class="note">
<p>이 단계에서는 Home Assistant 도커가 이미 NGINX 뒤에서 실행 중이고 외부에서 액세스 할 수 있다고 가정합니다. 또한 도커가 <code>--net='host'</code> 플래그로 실행되고 있다고 가정합니다.</p>
</div>
<p>Docker를 사용하는 사람들에게는 위의 자습서로 충분하지 않을 수 있습니다. 다음 단계는 NGINX 뒤의 Docker 내에서 홈 어시스턴트를 실행할 때 <code>fail2ban</code> 및 홈어시스턴트를 설정하는 방법을 구체적으로 설명합니다. 이 테스트는 linuxserver.io의 <a href="https://github.com/linuxserver/docker-letsencrypt" rel="external nofollow">let’s encrypt docker</a>를 사용한 unRAID 서버입니다.</p>
<h4>
<a class="title-link" name="http---set-http-logger" href="#http---set-http-logger"></a> http 로거 셋업 (Set http logger)</h4>
<p><code>configuration.yaml</code> 파일에서 다음 <code>logger</code> 통합구성요소에 추가하여 홈어시스턴트가 실패한 로그인 시도를 로그에 보이도록하십시오.</p>
<pre><code class="language-yaml">logger:
  logs:
    homeassistant.components.http.ban: warning
</code></pre>
<h4>
<a class="title-link" name="jaillocal-" href="#jaillocal-"></a> jail.local 편집하기</h4>
<p>다음으로, 위의 Let’s Encrypt 도커에 포함된 <code>jail.local</code> 파일을 편집해야합니다. 이 튜토리얼에서는 <a href="/cookbook/fail2ban/">previously linked tutorial</a>에서만 <code>[hass-iptables]</code> 감옥(jail)을 구현할 것입니다.</p>
<p><code>/mnt/user/appdata/letsencrypt/fail2ban/jail.local</code>을 편집하고 파일의 끝에 다음을 추가하십시오 :</p>
<pre><code class="language-txt">[hass-iptables]
enabled = true
filter = hass
action = iptables-allports[name=HASS]
logpath = /hass/home-assistant.log
maxretry = 5
</code></pre>
<h4>
<a class="title-link" name="-jail---" href="#-jail---"></a> 홈어시스턴트 감옥(jail)에 대한 필터 만들기</h4>
<p>이제 로그를 제대로 파싱 할 수 있도록 <code>fail2ban</code>에 대한 필터를 만들어야합니다. 이것은 <code>failregex</code>로 이루어집니다. <code>/mnt/user/appdata/letsencrypt/fail2ban</code>의 <code>filter.d</code> 디렉토리 내에 <code>hass.local</code>이라는 파일을 작성하고 다음을 추가하십시오.</p>
<pre><code class="language-txt">[INCLUDES]
before = common.conf

[Definition]
failregex = ^%(__prefix_line)s.*Login attempt or request with invalid authentication from &lt;HOST&gt;.*$

ignoreregex =

[Init]
datepattern = ^%%Y-%%m-%%d %%H:%%M:%%S
</code></pre>
<h4>
<a class="title-link" name="map-log-file-directories" href="#map-log-file-directories"></a> Map log file directories</h4>
<p>먼저 fail2ban 로그를 홈어시스턴트로 전달하고 홈어시스턴트 로그를 fail2ban로 전달할 수 있는지 확인해야합니다. Let’s Encrypt 도커를 시작할 때 다음 인수를 추가해야합니다 (설정에 따라 경로 조정)</p>
<pre><code class="language-txt">/mnt/user/appdata/home-assistant:/hass
</code></pre>
<p>그러면 홈어시스턴트 설정 디렉토리가 Let’s Encrypt 도커에 매핑되어 실패한 로그인 시도에 대해 <code>fail2ban</code>이 로그를 구문 분석 할 수 있습니다.</p>
<p>이제 홈어시스턴트 도커에 대해 동일한 작업을 수행하지만, 이번에는 fail2ban 센서가 해당 로그를 읽을 수 있도록 <code>fail2ban</code> 로그 디렉토리를 홈어시스턴트에 맵핑합니다.</p>
<pre><code class="language-txt">/mnt/user/appdata/letsencrypt/log/fail2ban:/fail2ban
</code></pre>
<h4>
<a class="title-link" name="--ip-" href="#--ip-"></a> 홈어시스턴트로 클라이언트 IP 보내기</h4>
<p>기본적으로, 홈어시스턴트가 보는 IP 주소는 컨테이너의 주소입니다 (<code>172.17.0.16</code>와 같은 것). 이는 실패한 로그인 시도에 대해 <code>fail2ban</code>을 올바르게 설정했다고 가정하면 Docker IP는 차단된 것으로 기록되지만 원래 IP는 여전히 시도를 할 수 있습니다. IP를 올바르게 차단하기 위해 원래 IP를 인식하는 <code>fail2ban</code> 이 필요합니다.</p>
<p>먼저 <code>/mnt/user/appdata/letsencrypt/nginx/site-confs/default</code>에 있는 nginx 설정 파일에 다음을 추가해야합니다.</p>
<pre><code class="language-bash">proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</code></pre>
<p>이 스니펫은 홈어시스턴트 서버 설정 내에 추가되어야합니다. 따라서 내용은 다음과 같습니다.</p>
<pre><code class="language-bash">server {
    ...
    location / {
        proxy_pass http://192.168.0.100:8123;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/websocket {
        proxy_pass http://192.168.0.100:8123/api/websocket;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    ...
}
</code></pre>
<p>일단 nginx 설정에 추가되면, <code>X-Forwarded-For</code> 헤더를 파싱 할 수 있도록 Home Assistant <code>configuration.yaml</code>을 수정해야합니다. <code>http</code> 컴포넌트에 다음을 추가하면됩니다 :</p>
<pre><code class="language-yaml">http:
  use_x_forwarded_for: true
</code></pre>
<p>이 시점에서 Let’s Encrypt 및 Home Assistant 도커가 다시 시작되면 홈어시스턴트는 실패한 로그인 시도의 원래 IP를 올바르게 기록해야합니다. 완료되고 확인되면 마지막 단계로 넘어갈 수 있습니다.</p>
<h4>
<a class="title-link" name="fail2ban-sensor-" href="#fail2ban-sensor-"></a> fail2ban sensor 추가하기</h4>
<p>Docker에 대한 모든 것을 올바르게 설정 했으므로 다음과 같이 센서를 <code>configuration.yaml</code> 에 추가 할 수 있습니다.</p>
<pre><code class="language-yaml">sensor:
  - platform: fail2ban
    jails:
      - hass-iptables
    file_path: /fail2ban/fail2ban.log
</code></pre>
<p>모든 단계를 수행했다고 가정하면 프런트 엔드 내에 하나의 fail2ban 센서 <code>sensor.fail2ban_hassiptables</code>가 있어야 합니다.</p>
<h3>
<a class="title-link" name="--" href="#--"></a> 다른 디버그 팁들</h3>
<p>이 단계를 수행 한 후에도 ‘fail2ban’센서가 작동하지 않는 경우 도움이 될 수있는 다른 단계는 다음과 같습니다.</p>
<ul>
<li>Add <code>logencoding = utf-8</code> to the <code>[hass-iptables]</code> entry</li>
<li>Ensure the <code>failregex</code> you added to <code>filter.d/hass.local</code> matches the output within <code>home-assistant.log</code>
</li>
<li>Try changing the datepattern in <code>filter.d/hass/local</code> by adding the following entry (change the datepattern to fit your needs). <a href="https://github.com/fail2ban/fail2ban/issues/174" rel="external nofollow">source</a>
<pre><code class="language-txt">[Init]
datepattern = ^%%Y-%%m-%%d %%H:%%M:%%S
</code></pre>
</li>
</ul>


</article>

          
        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">
  
  
    <section class="aside-module grid__item one-whole lap-one-half">

<div class='edit-github'><a href='https://github.com/hakorea/gitpages_source/blob/master/source/_integrations/fail2ban.markdown'>깃허브 편집</a></div>

<div class='brand-logo-container section'><img src='/images/supported_brands/fail2ban.png' /></div><div class="section">
    <kb-alert-link integration="fail2ban"></kb-alert-link>
  </div><div class='section'>
      IoT class<sup><a href='/blog/2016/02/12/classifying-the-internet-of-things/#classifiers'><i class="icon-info-sign"></i></a></sup>: Local Polling
    </div><div class='section'>
      Introduced in release: 0.57
    </div><div class='section'>
    Source: <a href='https://github.com/home-assistant/home-assistant/blob/dev/homeassistant/components/fail2ban/'>/components/fail2ban/</a>
  </div><div class='section'>
    <h1 class="title delta">카테고리</h1>
    <ul class='divided'><li>
        <a href='/integrations/#network'>Network</a>
      </li></ul>
    </div></section>

<script src="https://alerts.home-assistant.io/ce-alert-link.js"></script>

  
</div>

        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <div class="copyright grid">
        <div class='company grid__item one-third lap-one-half palm-one-whole'>
          <div class="title">
            <img src="/images/home-assistant-logo.png" width="36" height="36" alt="Home Assistant"> 홈어시스턴트
          </div>
        </div>

        <div class='grid__item one-third lap-one-half palm-one-whole'>
          <ul>
            <li><a href='https://alerts.home-assistant.io'>Home Assistant Alerts</a></li>
            <li><a href='https://cafe.naver.com/koreassistant'>HA 네이버 카페</a></li>
          </ul>
        </div>

        <div class='grid__item one-third lap-one-half palm-one-whole'>
          이 웹사이트는 <a href='https://jekyllrb.com/'>Jekyll</a>과
          <a href='https://github.com/coogie/oscailte'>Oscalite 테마</a>를 사용합니다.
        </div>
      </div>
    </div>
  </div>
</div>

    </footer>

    <script>
var _gaq=[['_setAccount',''],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<script src="/javascripts/prism.js?5d6619066a1fc5cd819a93c132b539ac" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
docsearch({
  apiKey: 'c762b5632da4220f398f985614f3a1e3',
  indexName: 'hakorea',
  inputSelector: '#search',
  debug: false // Set debug to true if you want to inspect the dropdown
});
document.querySelector('.search .close').addEventListener('click', function(ev) {
  ev.preventDefault();
  document.querySelector('.search-container').style.display = 'none';
});
document.querySelector('.show-search').addEventListener('click', function(ev) {
  ev.preventDefault();
  document.querySelector('.search-container').style.display = 'block';
  document.getElementById('toggle').checked = false;
  document.querySelector('.search-container input').focus();
});
</script>

  </body>
</html>
